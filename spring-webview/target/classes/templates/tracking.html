<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${title}">Tracking</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<header th:replace="~{constants/header :: header(${headerUserName}, ${headerUserRole})}"></header>

<main class="main-content fade-in">
    <div class="container" id="tracking-root"
         th:attr="data-tracking-base=@{/tracking/}">
        <div class="tracking-shell max-w-xl mx-auto mt-10 fade-in">
            <section class="tracking-card tracking-hero">
                <div class="tracking-header">
                    <div class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="package" class="text-blue-600 w-8 h-8"></i>
                    </div>
                    <h1 class="tracking-title">Track your <span>Shipment</span></h1>
                    <p class="tracking-subtitle">Real-time status updates across the Tavall network.</p>
                </div>

                <form class="tracking-search" th:action="@{/tracking}" method="get">
                    <div class="tracking-search-row">
                        <input id="track-input" name="trackingNumber" type="text"
                               class="tracking-input mono"
                               placeholder="Enter tracking number"
                               autocomplete="off"
                               spellcheck="false"
                               th:value="${trackingNumber}">
                        <button class="btn-primary" type="submit">Track</button>
                    </div>
                    <p class="tracking-hint">Paste a tracking number to search instantly.</p>
                </form>
            </section>

            <section class="tracking-card tracking-card-alt">
                <form class="tracking-batch" th:action="@{/tracking}" method="get">
                    <label class="tracking-label">Track Multiple Shipments</label>
                    <textarea name="batch" rows="3"
                              class="tracking-textarea mono"
                              placeholder="Paste tracking numbers separated by commas or new lines"></textarea>
                    <div class="tracking-batch-actions">
                        <button class="btn-secondary" type="submit">Track Batch</button>
                    </div>
                </form>
            </section>

            <section th:if="${currentUserRole != null && currentUserRole != 'GUEST'}"
                     class="tracking-card tracking-card-alt">
                <h3 class="tracking-section-title">Signed-In Tools</h3>
                <p class="tracking-subtitle">Quick access based on your role.</p>
                <div class="tracking-quick-actions flex flex-wrap gap-2">
                    <a class="btn-primary gap-2 items-center" th:href="@{/dashboard}">
                        <i data-lucide="home"></i>
                        Dashboard
                    </a>
                    <a class="btn-secondary gap-2 items-center"
                       th:if="${currentUserRole == 'MERCHANT' or currentUserRole == 'SUPERUSER'}"
                       th:href="@{/dashboard/merchant/shipments}">
                        <i data-lucide="archive"></i>
                        Shipment Library
                    </a>
                    <a class="btn-secondary gap-2 items-center"
                       th:if="${currentUserRole == 'MERCHANT' or currentUserRole == 'SUPERUSER'}"
                       th:href="@{/dashboard/merchant/routes}">
                        <i data-lucide="route"></i>
                        Routes
                    </a>
                    <a class="btn-secondary gap-2 items-center"
                       th:if="${currentUserRole == 'DRIVER'}"
                       th:href="@{/dashboard/driver}">
                        <i data-lucide="navigation"></i>
                        Driver Hub
                    </a>
                    <a class="btn-secondary gap-2 items-center"
                       th:if="${currentUserRole == 'SUPERUSER'}"
                       th:href="@{/dashboard/superuser}">
                        <i data-lucide="shield-check"></i>
                        Admin Console
                    </a>
                </div>
            </section>

            <div id="track-result" th:if="${trackingResult != null}">
                <div class="tracking-card tracking-card-alt">
                    <h3 class="tracking-section-title">Tracking Details</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tracking Number</label>
                            <div class="scan-field mono" th:text="${trackingResult.trackingNumber}"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Recipient</label>
                            <div class="scan-field" th:text="${trackingResult.recipientName}"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Delivery Status</label>
                            <div class="scan-field" th:text="${trackingStatusMessage}"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Deliver By</label>
                            <div class="scan-field"
                                 th:text="${trackingResult.deliverBy != null ? 'DEADLINE: ' + #temporals.format(trackingResult.deliverBy, 'MM/dd/yyyy hh:mm a') : 'DEADLINE: N/A'}"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Address</label>
                            <div class="scan-field" th:text="${trackingResult.address}"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="track-result-empty" th:if="${trackingNumber != null && trackingResult == null}" class="tracking-card tracking-card-alt tracking-empty">
                No shipment found for <span class="mono" th:text="${trackingNumber}"></span>.
            </div>

            <div th:if="${!#lists.isEmpty(batchResults)}" class="mt-8">
                <h3 class="tracking-section-title tracking-section-title-small">Batch Results</h3>
                <div class="tracking-card tracking-card-alt tracking-batch-results">
                    <div th:each="label : ${batchResults}" class="p-4 border-b border-slate-100 flex items-center justify-between">
                        <div>
                            <div class="text-sm font-bold text-slate-700" th:text="${label.trackingNumber}"></div>
                            <div class="text-xs text-slate-400"
                                 th:text="${batchStatusMessages[label.trackingNumber]}"></div>
                        </div>
                        <a class="text-blue-500 hover:text-blue-700 text-sm font-medium"
                           th:href="@{/tracking/{trackingNumber}(trackingNumber=${label.trackingNumber})}">View</a>
                    </div>
                </div>
            </div>

            <div class="text-center mt-10">
                <a th:if="${currentUserRole == null || currentUserRole == 'GUEST'}"
                   th:href="@{/dashboard/login}" class="text-sm text-slate-400 hover:text-slate-600">
                    Dashboard login instead
                </a>
                <a th:if="${currentUserRole != null && currentUserRole != 'GUEST'}"
                   th:href="@{/dashboard}" class="text-sm text-slate-400 hover:text-slate-600">
                    Return to Dashboard
                </a>
            </div>
        </div>
    </div>
</main>

<script>
    lucide.createIcons();
    (function () {
        const input = document.getElementById("track-input");
        const root = document.getElementById("tracking-root");
        if (!input || !root) return;
        const base = root.getAttribute("data-tracking-base") || "/tracking/";
        const normalizedBase = base.endsWith("/") ? base : base + "/";
        let timer = null;

        const triggerSearch = function (value) {
            const normalized = value.trim().toUpperCase();
            if (normalized.length < 4) return;
            clearTimeout(timer);
            timer = setTimeout(function () {
                const target = normalizedBase + encodeURIComponent(normalized);
                window.location.href = target;
            }, 350);
        };

        const scheduleFromInput = () => triggerSearch(input.value);

        input.addEventListener("input", scheduleFromInput);

        input.addEventListener("paste", function (event) {
            const text = event.clipboardData ? event.clipboardData.getData("text") : "";
            if (text && text.trim().length) {
                event.preventDefault();
                input.value = text.trim();
                triggerSearch(input.value);
                return;
            }
            requestAnimationFrame(scheduleFromInput);
        });
    })();
</script>
</body>
</html>
