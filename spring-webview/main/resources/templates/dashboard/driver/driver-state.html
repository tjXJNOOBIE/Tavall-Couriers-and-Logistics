<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${title}">State Change</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<main th:class="${@dashboardTemplateCss.join('main-content fade-in')}">
    <div th:class="${@dashboardTemplateCss.join('container')}">
        <section th:class="${@dashboardTemplateCss.join('space-y-4')}">
            <div th:if="${transitionStatus != null}" th:class="${@dashboardTemplateCss.join('alert alert-success')}" th:text="${transitionStatus}">
                State updated.
            </div>
            <div th:if="${transitionError != null}" th:class="${@dashboardTemplateCss.join('alert alert-danger')}" th:text="${transitionError}">
                State update failed.
            </div>
            <div th:class="${@dashboardTemplateCss.join('scan-panel-card tavall-popup-panel space-y-4')}">
                <div>
                    <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-400 uppercase tracking-wider')}">State Change</div>
                    <div th:class="${@dashboardTemplateCss.join('text-2xl font-bold text-slate-800')}">Shipment Details</div>
                    <div th:class="${@dashboardTemplateCss.join('text-sm text-slate-500')}">Review the label and update its state.</div>
                </div>

                <div th:if="${selectedLabel == null}" th:class="${@dashboardTemplateCss.join('scan-status text-slate-500')}">
                    Awaiting QR scan.
                </div>

                <div th:if="${selectedLabel != null}" th:class="${@dashboardTemplateCss.join('space-y-3')}">
                    <div th:class="${@dashboardTemplateCss.join('scan-detail-grid')}">
                        <div th:class="${@dashboardTemplateCss.join('scan-field scan-field-span')}">
                            <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-500 uppercase mb-1')}">Tracking</div>
                            <div th:class="${@dashboardTemplateCss.join('mono')}" th:text="${selectedLabel.trackingNumber}"></div>
                        </div>
                        <div th:class="${@dashboardTemplateCss.join('scan-field')}">
                            <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-500 uppercase mb-1')}">Recipient</div>
                            <div th:text="${selectedLabel.recipientName}"></div>
                        </div>
                        <div th:class="${@dashboardTemplateCss.join('scan-field')}">
                            <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-500 uppercase mb-1')}">State</div>
                            <span th:class="${@dashboardTemplateCss.join('badge badge-neutral')}"
                                  th:text="${selectedLabel.deliveryState != null ? selectedLabel.deliveryState.displayName() : 'N/A'}">STATE</span>
                        </div>
                        <div th:class="${@dashboardTemplateCss.join('scan-field scan-field-span')}">
                            <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-500 uppercase mb-1')}">Address</div>
                            <div th:text="${selectedLabel.address}"></div>
                        </div>
                        <div th:class="${@dashboardTemplateCss.join('scan-field')}">
                            <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-500 uppercase mb-1')}">City</div>
                            <div th:text="${selectedLabel.city + (selectedLabel.state != null ? ', ' + selectedLabel.state : '')}"></div>
                        </div>
                        <div th:class="${@dashboardTemplateCss.join('scan-field')}">
                            <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-500 uppercase mb-1')}">Zip</div>
                            <div th:text="${selectedLabel.zipCode}"></div>
                        </div>
                        <div th:class="${@dashboardTemplateCss.join('scan-field scan-field-span')}">
                            <div th:class="${@dashboardTemplateCss.join('text-xs font-bold text-slate-500 uppercase mb-1')}">Deadline</div>
                            <div th:text="${selectedLabel.deliverBy != null ? 'DEADLINE: ' + #temporals.format(selectedLabel.deliverBy, 'MM/dd/yyyy hh:mm a') : 'DEADLINE: N/A'}"></div>
                        </div>
                    </div>
                </div>

                <div th:class="${@dashboardTemplateCss.join('flex flex-wrap gap-3 justify-end')}">
                    <button th:class="${@dashboardTemplateCss.join('btn-primary flex-1 md:flex-none')}"
                            type="button"
                            data-state-open="true"
                            th:disabled="${selectedLabel == null}">
                        <i data-lucide="refresh-ccw" th:class="${@dashboardTemplateCss.join('w-4 h-4')}"></i>
                        Update Shipment
                    </button>
                    <a th:class="${@dashboardTemplateCss.join('btn-secondary flex-1 md:flex-none')}"
                       th:if="${selectedLabel != null}"
                       th:href="@{/shipping-labels/{uuid}(uuid=${selectedLabel.uuid})}"
                       data-label-popup="true">
                        <i data-lucide="external-link" th:class="${@dashboardTemplateCss.join('w-4 h-4')}"></i>
                        Open Details
                    </a>
                </div>
            </div>
        </section>
    </div>
</main>

<div id="stateModal" th:class="${@dashboardTemplateCss.join('scan-modal state-modal')}" hidden>
    <div th:class="${@dashboardTemplateCss.join('scan-modal-backdrop')}" data-state-close="true"></div>
    <div th:class="${@dashboardTemplateCss.join('scan-modal-panel state-modal-panel tavall-popup-panel space-y-4')}">
        <div>
            <div th:class="${@dashboardTemplateCss.join('state-modal-title')}">Update Delivery State</div>
            <p th:class="${@dashboardTemplateCss.join('state-modal-sub')}"
               th:text="${selectedLabel != null ? 'Current: ' + selectedLabel.deliveryState.displayName() : 'Scan a label to enable state changes.'}">
                Current: Label Created
            </p>
        </div>
        <form method="post" th:action="@{/internal/api/v1/driver/package/transition}">
            <input type="hidden" th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="uuid" th:value="${selectedLabel != null ? selectedLabel.uuid : ''}"/>
            <div th:class="${@dashboardTemplateCss.join('state-grid')}">
                <button th:each="state : ${allStates}"
                        th:class="${@dashboardTemplateCss.join('state-option')}"
                        th:classappend="${#sets.contains(allowedTransitions, state)} ? ' state-option-allowed' : ' state-option-blocked'"
                        th:disabled="${selectedLabel == null || !#sets.contains(allowedTransitions, state)}"
                        name="nextState"
                        th:value="${state}"
                        type="submit"
                        th:text="${state.displayName()}">STATE</button>
            </div>
        </form>
        <div th:class="${@dashboardTemplateCss.join('flex justify-end')}">
            <button th:class="${@dashboardTemplateCss.join('btn-secondary')}" type="button" data-state-close="true">Cancel</button>
        </div>
    </div>
</div>

<div id="labelModal" th:class="${@dashboardTemplateCss.join('scan-modal label-popup-modal')}" hidden>
    <div id="labelModalBackdrop" th:class="${@dashboardTemplateCss.join('scan-modal-backdrop')}"></div>
    <div th:class="${@dashboardTemplateCss.join('scan-modal-panel label-popup-panel tavall-popup-panel')}">
        <iframe id="labelModalFrame"
                th:class="${@dashboardTemplateCss.join('scan-modal-frame label-popup-frame')}"
                title="Label details"
                loading="lazy"></iframe>
    </div>
</div>

<script defer src="/js/label-popup.js"></script>

<script>
    lucide.createIcons();
    (function () {
        const isEmbedded = window.parent && window.parent !== window;
        if (isEmbedded) {
            document.body.classList.add("label-popup-embedded");
            document.documentElement.classList.add("label-popup-embedded");
        }

        const modal = document.getElementById("stateModal");
        const openStateBtn = document.querySelector("[data-state-open]");

        const closeModal = () => {
            if (!modal) return;
            modal.classList.remove("open");
            setTimeout(() => {
                modal.setAttribute("hidden", "hidden");
            }, 220);
        };

        const openModal = () => {
            if (!modal) return;
            modal.removeAttribute("hidden");
            requestAnimationFrame(() => modal.classList.add("open"));
        };

        if (openStateBtn) {
            openStateBtn.addEventListener("click", openModal);
        }

        if (modal) {
            modal.querySelectorAll("[data-state-close]").forEach((btn) => {
                btn.addEventListener("click", closeModal);
            });
        }

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                closeModal();
            }
        });

        if (isEmbedded) {
            const postHeight = () => {
                const height = document.documentElement.scrollHeight;
                window.parent.postMessage({ type: "stateModalResize", height }, window.location.origin);
            };
            window.addEventListener("load", postHeight);
            window.addEventListener("resize", postHeight);
            setTimeout(postHeight, 0);
        }
    })();
</script>

</body>
</html>
