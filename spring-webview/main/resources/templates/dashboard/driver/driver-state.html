<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${title}">State Change</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<main class="main-content fade-in">
    <div class="container">
        <section class="card">
            <div class="mt-2">
                <div class="scan-panel-card tavall-popup-panel">
                    <div class="scan-panel-header">
                        <div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">State Change</div>
                            <div class="text-lg font-bold text-slate-800">Shipment Details</div>
                            <div class="text-sm text-slate-500">Review the label and update its state.</div>
                        </div>
                    </div>

                    <div th:if="${transitionStatus != null}" class="alert alert-success" th:text="${transitionStatus}">
                        State updated.
                    </div>
                    <div th:if="${transitionError != null}" class="alert alert-danger" th:text="${transitionError}">
                        State update failed.
                    </div>

                    <div th:if="${selectedLabel == null}" class="scan-status text-slate-500">
                        Awaiting QR scan.
                    </div>

                    <div th:if="${selectedLabel != null}" class="scan-detail-grid">
                        <div class="scan-field scan-field-span">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Tracking</div>
                            <div class="mono" th:text="${selectedLabel.trackingNumber}"></div>
                        </div>
                        <div class="scan-field">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Recipient</div>
                            <div th:text="${selectedLabel.recipientName}"></div>
                        </div>
                        <div class="scan-field">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">State</div>
                            <span class="badge badge-neutral"
                                  th:text="${selectedLabel.deliveryState != null ? selectedLabel.deliveryState.displayName() : 'N/A'}">STATE</span>
                        </div>
                        <div class="scan-field scan-field-span">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Address</div>
                            <div th:text="${selectedLabel.address}"></div>
                        </div>
                        <div class="scan-field">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">City</div>
                            <div th:text="${selectedLabel.city + (selectedLabel.state != null ? ', ' + selectedLabel.state : '')}"></div>
                        </div>
                        <div class="scan-field">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Zip</div>
                            <div th:text="${selectedLabel.zipCode}"></div>
                        </div>
                        <div class="scan-field scan-field-span">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Deadline</div>
                            <div th:text="${selectedLabel.deliverBy != null ? 'DEADLINE: ' + #temporals.format(selectedLabel.deliverBy, 'MM/dd/yyyy hh:mm a') : 'DEADLINE: N/A'}"></div>
                        </div>
                    </div>

                    <div class="scan-panel-actions">
                        <button class="btn-primary" type="button" data-state-open="true"
                                th:disabled="${selectedLabel == null}">Change State</button>
                        <a class="btn-secondary"
                           th:if="${selectedLabel != null}"
                           th:href="@{/shipping-labels/{uuid}(uuid=${selectedLabel.uuid})}"
                           target="_blank" rel="noopener">Open Details</a>
                    </div>
                </div>
            </div>

            <div class="label-popup-topbar">
                <button class="label-popup-close" type="button" id="statePopupClose">Close</button>
            </div>
        </section>
    </div>
</main>

<div id="stateModal" class="scan-modal state-modal" hidden>
    <div class="scan-modal-backdrop" data-state-close="true"></div>
    <div class="scan-modal-panel state-modal-panel tavall-popup-panel">
        <button type="button" data-state-close="true" aria-label="Close state menu">
            &times;
        </button>
        <h3 class="state-modal-title">Update Delivery State</h3>
        <p class="state-modal-sub"
           th:text="${selectedLabel != null ? 'Current: ' + selectedLabel.deliveryState.displayName() : 'Scan a label to enable state changes.'}">
            Current: Label Created
        </p>
        <form method="post" th:action="@{/internal/api/v1/driver/package/transition}">
            <input type="hidden" th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="uuid" th:value="${selectedLabel != null ? selectedLabel.uuid : ''}"/>
            <div class="state-grid">
                <button th:each="state : ${allStates}"
                        class="state-option"
                        th:classappend="${#sets.contains(allowedTransitions, state)} ? ' state-option-allowed' : ' state-option-blocked'"
                        th:disabled="${selectedLabel == null || !#sets.contains(allowedTransitions, state)}"
                        name="nextState"
                        th:value="${state}"
                        type="submit"
                        th:text="${state.displayName()}">STATE</button>
            </div>
        </form>
    </div>
</div>

<script>
    lucide.createIcons();
    (function () {
        const isEmbedded = window.parent && window.parent !== window;
        if (isEmbedded) {
            document.body.classList.add("label-popup-embedded");
            document.documentElement.classList.add("label-popup-embedded");
        }

        const close = () => {
            if (isEmbedded) {
                window.parent.postMessage({ type: "stateModalClose" }, window.location.origin);
                return;
            }
            window.location.href = "/dashboard/driver";
        };

        const closeBtn = document.getElementById("statePopupClose");
        if (closeBtn) {
            closeBtn.addEventListener("click", close);
        }

        const modal = document.getElementById("stateModal");
        const openStateBtn = document.querySelector("[data-state-open]");

        const closeModal = () => {
            if (!modal) return;
            modal.classList.remove("open");
            setTimeout(() => {
                modal.setAttribute("hidden", "hidden");
            }, 220);
        };

        const openModal = () => {
            if (!modal) return;
            modal.removeAttribute("hidden");
            requestAnimationFrame(() => modal.classList.add("open"));
        };

        if (openStateBtn) {
            openStateBtn.addEventListener("click", openModal);
        }

        if (modal) {
            modal.querySelectorAll("[data-state-close]").forEach((btn) => {
                btn.addEventListener("click", closeModal);
            });
        }

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                closeModal();
            }
        });

        if (isEmbedded) {
            const postHeight = () => {
                const height = document.documentElement.scrollHeight;
                window.parent.postMessage({ type: "stateModalResize", height }, window.location.origin);
            };
            window.addEventListener("load", postHeight);
            window.addEventListener("resize", postHeight);
            setTimeout(postHeight, 0);
        }
    })();
</script>

</body>
</html>
