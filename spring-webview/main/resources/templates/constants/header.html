<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<header class="navbar" th:fragment="header(userName, userRole)">
    <a class="brand" th:href="@{/}" aria-label="Tavall Couriers home">
        <span class="brand-logo" aria-hidden="true"></span>
        <span class="brand-text">Tavall <span>Couriers</span></span>
    </a>

    <div class="user-controls">
        <div class="user-info hidden-mobile"
             th:with="
                role=${userRole != null ? userRole : ''},
                roleLabel=${(role != null && !#strings.isEmpty(role)) ? role : 'GUEST'},
                title=${role == 'DRIVER' ? 'Driver Console'
                       : role == 'MERCHANT' ? 'Merchant Console'
                       : role == 'SUPERUSER' ? 'Superuser Console'
                       : role == 'ADMIN' ? 'Admin Console'
                       : (userName != null && !#strings.isEmpty(userName) ? userName : 'Tavall Couriers')},
                detail=${(role == 'DRIVER' or role == 'MERCHANT' or role == 'SUPERUSER' or role == 'ADMIN')
                        ? (userName != null && !#strings.isEmpty(userName) ? userName : roleLabel)
                        : roleLabel}">
            <div class="user-name" th:text="${title}">Dev Mode</div>
            <div class="user-role" th:text="${detail}">LOCAL</div>
        </div>
        <button class="btn-icon" id="userMenuToggle" aria-label="User menu" aria-controls="userMenu" aria-expanded="false" type="button">&#9776;</button>
    </div>

    <div id="userMenu" class="user-tray" aria-hidden="true">
        <div class="user-tray-panel">
            <div class="user-tray-header">
                <div>
                    <div class="user-tray-title">Session</div>
                    <p class="user-tray-sub"
                       th:text="${(userRole != null && userRole != 'GUEST') ? 'Signed in as ' + userName : 'Browsing as guest'}">
                        Signed in.
                    </p>
                </div>
                <button class="btn-secondary" type="button" id="userMenuClose">Close</button>
            </div>

            <div class="user-tray-links">
                <div class="user-tray-section-title">Quick Links</div>
                <a class="user-tray-link" th:href="@{/}">Home</a>
                <a class="user-tray-link" th:href="@{/dashboard}">Dashboard</a>
                <a class="user-tray-link" th:href="@{/tracking}">Tracking</a>
            </div>

            <div class="user-tray-actions">
                <a class="btn-primary" th:if="${userRole == null || userRole == 'GUEST'}"
                   th:href="@{/dashboard/login}">
                    Log in
                </a>
                <form th:if="${userRole != null && userRole != 'GUEST'}"
                      th:action="@{/dashboard/logout}"
                      method="post">
                    <input type="hidden" th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button class="btn-primary" type="submit">Log out</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const menu = document.getElementById("userMenu");
            const toggle = document.getElementById("userMenuToggle");
            const closeBtn = document.getElementById("userMenuClose");
            const body = document.body;
            if (!menu || !toggle) return;

            const closeMenu = () => {
                body.classList.remove("sidebar-open");
                menu.setAttribute("aria-hidden", "true");
                toggle.setAttribute("aria-expanded", "false");
            };

            const openMenu = () => {
                body.classList.add("sidebar-open");
                menu.setAttribute("aria-hidden", "false");
                toggle.setAttribute("aria-expanded", "true");
            };

            toggle.addEventListener("click", (event) => {
                event.stopPropagation();
                if (body.classList.contains("sidebar-open")) {
                    closeMenu();
                } else {
                    openMenu();
                }
            });

            if (closeBtn) {
                closeBtn.addEventListener("click", closeMenu);
            }

            document.addEventListener("click", (event) => {
                if (!body.classList.contains("sidebar-open")) return;
                if (!menu.contains(event.target) && event.target !== toggle) {
                    closeMenu();
                }
            });

            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape") {
                    closeMenu();
                }
            });
        })();
    </script>
</header>
</body>
</html>

