<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${title}">Driver Scan</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<div class="scan-popup scan-camera-popup fade-in" data-camera-mode-key="driverState">
    <div class="scan-topbar">
        <span class="text-white font-mono text-xs opacity-70">DRIVER QR v1.0</span>
    </div>

    <div class="scan-layout single">
        <div>
            <div class="scan-frame">
                <div class="scan-video-wrap">
                    <video id="live-feed" autoplay muted playsinline></video>
                    <canvas id="frame-buffer" style="display:none;"></canvas>
                </div>
                <div class="scan-state-overlay">
                    <div id="scan-state-badge" class="scan-state-badge">SEARCHING</div>
                    <div class="scan-state-pulse" aria-hidden="true"></div>
                </div>
                <div class="scan-data-overlay" aria-live="polite">
                    <div class="scan-data-flash"></div>
                </div>
            </div>

            <div class="scan-actions scan-camera-actions">
                <button id="btn-toggle-source" class="scan-toggle" type="button">Switch to Screen Share</button>
                <button class="btn-secondary scan-close" type="button" data-scan-close="true">Close</button>
            </div>
        </div>
    </div>

    <div class="scan-popup-footer">
        <button class="btn-secondary scan-close" type="button" data-scan-close="true">
            Close
        </button>
    </div>
</div>

<script th:inline="javascript">
    window.APP = window.APP || {};
    window.APP.endpoints = window.APP.endpoints || {};
    window.APP.endpoints.configHandshake = /*[[@{/internal/api/v1/config/handshake}]]*/ "/internal/api/v1/config/handshake";
</script>
<script src="/js/camera.js" defer></script>
<script>
    lucide.createIcons();
    (function () {
        const closeBtn = document.querySelector("[data-scan-close]");
        if (!closeBtn) return;
        const closeTarget = "/dashboard/driver";
        const isEmbedded = window.parent && window.parent !== window;
        if (isEmbedded) {
            document.body.classList.add("scan-embedded");
            document.documentElement.classList.add("scan-embedded");
        }
        closeBtn.addEventListener("click", () => {
            if (isEmbedded) {
                window.parent.postMessage({ type: "scanModalClose" }, window.location.origin);
                return;
            }
            window.location.href = closeTarget;
        });

        if (isEmbedded) {
            const postHeight = () => {
                const height = document.documentElement.scrollHeight;
                window.parent.postMessage({ type: "scanModalResize", height }, window.location.origin);
            };
            window.addEventListener("load", postHeight);
            window.addEventListener("resize", postHeight);
            setTimeout(postHeight, 0);
        }
    })();
</script>

</body>
</html>
