<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<header class="navbar" th:fragment="header(userName, userRole)">
    <a class="brand" th:href="@{/}" aria-label="Tavall Couriers home">
        <span class="brand-logo" aria-hidden="true">
            <span class="brand-logo-icon"></span>
        </span>
        <span class="brand-text">Tavall <span>Couriers</span></span>
    </a>

    <div class="user-controls">
        <div class="user-info hidden-mobile"
             th:with="
                role=${userRole != null ? userRole : ''},
                roleLabel=${(role != null && !#strings.isEmpty(role)) ? role : 'GUEST'},
                title=${(userName != null && !#strings.isEmpty(userName)) ? userName : 'Tavall Couriers'}">
            <div class="user-name" th:text="${title}">Tavall Couriers</div>
            <div class="user-role" th:text="${roleLabel}">GUEST</div>
        </div>
        <button class="btn-icon" id="userMenuToggle" aria-label="User menu" aria-controls="userMenu" aria-expanded="false" type="button">&#9776;</button>
    </div>

    <div id="userMenu" class="user-tray" aria-hidden="true">
        <div class="user-tray-panel">
            <div class="user-tray-links">
                <div class="user-tray-section-title">Quick Links</div>
                <a class="user-tray-link" th:href="@{/}">Home</a>
                <a class="user-tray-link" th:href="@{/tracking}">Tracking</a>
                <a class="user-tray-link"
                   th:if="${userRole == 'DRIVER' or userRole == 'MERCHANT' or userRole == 'SUPERUSER' or userRole == 'ADMIN'}"
                   th:href="@{/dashboard}">Dashboard</a>
                <a class="user-tray-link"
                   th:if="${userRole == null || userRole == 'GUEST'}"
                   th:href="@{/dashboard/login}">Dashboard Login</a>
            </div>

            <div class="user-tray-links" th:if="${userRole == 'DRIVER'}">
                <div class="user-tray-section-title">Driver Tools</div>
                <a class="user-tray-link" th:href="@{/dashboard/driver}">Driver Hub</a>
                <a class="user-tray-link" th:href="@{/dashboard/driver/scan}">Scan Package</a>
                <a class="user-tray-link" th:href="@{/dashboard/driver/create-label}">New Label</a>
            </div>

            <div class="user-tray-links" th:if="${userRole == 'MERCHANT'}">
                <div class="user-tray-section-title">Merchant Tools</div>
                <a class="user-tray-link" th:href="@{/dashboard/merchant}">Merchant Hub</a>
                <a class="user-tray-link" th:href="@{/dashboard/merchant/scan}">Scan Intake</a>
                <a class="user-tray-link" th:href="@{/dashboard/merchant/shipments}">Shipments</a>
                <a class="user-tray-link" th:href="@{/dashboard/merchant/routes}">Routes</a>
            </div>

            <div class="user-tray-links" th:if="${userRole == 'SUPERUSER' or userRole == 'ADMIN'}">
                <div class="user-tray-section-title">Admin Tools</div>
                <a class="user-tray-link" th:href="@{/dashboard/superuser}">Admin Console</a>
                <a class="user-tray-link" th:href="@{/dashboard/admin/users}">Manage Users</a>
                <a class="user-tray-link" th:href="@{/dashboard/merchant/shipments}">Shipments</a>
            </div>

            <div class="user-tray-actions">
                <a class="btn-primary" th:if="${userRole == null || userRole == 'GUEST'}"
                   th:href="@{/dashboard/login}">
                    Log in
                </a>
                <form th:if="${userRole != null && userRole != 'GUEST'}"
                      th:action="@{/dashboard/logout}"
                      method="post">
                    <input type="hidden" th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button class="btn-primary" type="submit">Log out</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const menu = document.getElementById("userMenu");
            const toggle = document.getElementById("userMenuToggle");
            const closeBtn = document.getElementById("userMenuClose");
            const body = document.body;
            if (!menu || !toggle) return;

            const closeMenu = () => {
                body.classList.remove("sidebar-open");
                menu.setAttribute("aria-hidden", "true");
                toggle.setAttribute("aria-expanded", "false");
            };

            const openMenu = () => {
                body.classList.add("sidebar-open");
                menu.setAttribute("aria-hidden", "false");
                toggle.setAttribute("aria-expanded", "true");
            };

            toggle.addEventListener("click", (event) => {
                event.stopPropagation();
                if (body.classList.contains("sidebar-open")) {
                    closeMenu();
                } else {
                    openMenu();
                }
            });

            if (closeBtn) {
                closeBtn.addEventListener("click", closeMenu);
            }

            document.addEventListener("click", (event) => {
                if (!body.classList.contains("sidebar-open")) return;
                if (!menu.contains(event.target) && event.target !== toggle) {
                    closeMenu();
                }
            });

            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape") {
                    closeMenu();
                }
            });
        })();
    </script>
</header>
</body>
</html>

